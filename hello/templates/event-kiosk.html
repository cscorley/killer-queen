{% extends 'base.html' %}

{% load tz %}
{% load static %}

{% block scripts %}
<script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="//cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<script src="//cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
{% csrf_token %}
<script>
var csrfToken = jQuery("[name=csrfmiddlewaretoken]").val();

Vue.http.interceptors.push(function(request) {
  request.headers.set('X-CSRFToken', csrfToken);
});

function ExtractString(text,startS,endS)
{
    var indexS = text.indexOf(startS)+startS.length;
    var indexE = text.lastIndexOf(endS);
    if(indexE < indexS)
        return "";
    return text.substring(indexS,indexE);
}

function connectSocket(vueApp)
{
    var socket = new WebSocket("ws://" + vueApp.cabAddress + ":12749")
    socket.onmessage = function(event) {
        var msg = ExtractString(event.data,"![","]!");
        if(msg == null)
        {
            return;
        }
        var key = ExtractString(msg, "k[", "],v");
        var value = ExtractString(msg, "v[", "]");
        if (key === "bracket")
        {
            console.log(value)
            var tournament = JSON.parse(value)
            console.log(tournament)
            vueApp.sets = []
            if (tournament.format === "r")
            {
                for (var bracket of tournament.brackets)
                {
                    for (var round of bracket.rounds)
                    {
                        for (var set of round.sets)
                        {
                            if (set.id > 0)
                            {
                                vueApp.sets.push(set)
                            }
                        }
                    }
                }
            }
        }
        else if (key === "currentmatch")
        {
            var currentMatch =  JSON.parse(value)
            console.log(currentMatch)

            vueApp.currentMatch.onBlue = (currentMatch.team1 === undefined) ? "TBD" : currentMatch.team1
            vueApp.currentMatch.onGold = (currentMatch.team2 === undefined) ? "TBD" : currentMatch.team2
            vueApp.currentMatch.upBlue = (currentMatch.next1 === undefined) ? "TBD" : currentMatch.team1
            vueApp.currentMatch.upGold = (currentMatch.next2 === undefined) ? "TBD" : currentMatch.team2

            socket.send("![k[get],v[bracket]]!")
        }
        else if (key == "victory")
        {
            socket.send("![k[get],v[currentmatch]]!")
        }
        else if (key == "alive")
        {
            socket.send("![k[im alive],v[mixerApp]]!")
        }

        vueApp.connected = true
    };

    socket.onclose = function(event)
    {
        vueApp.connected = false
    }

    socket.onopen = function(event)
    {
        vueApp.connected = true
        socket.send("![k[connect],v[{\"name\":\"mixerApp\",\"isGameMachine\":false}]]!")
        socket.send("![k[get],v[currentmatch]]!")
    }

    return socket
}

var app = new Vue({
    el: '#vueApp',
    delimiters: ['${', '}'],
    data: {
        sets: [],
        cabAddress: '192.168.50.3',
        connected: false,
        currentMatch: {
            onBlue: "Unknown",
            onGold: "Unknown",
            nextBlue: "Unknown",
            nextGold: "Unknown"
        },
        socket: null
    },
    methods: {
        reconnect: function()
        {
            this.socket = connectSocket(this)
        }
    },
    mounted () {
        console.log('vue-native-websocket mounted/connected=', this.connected)
    },
    created () {
        console.log('vue-native-websocket created/connected=', this.connected)
        this.reconnect()
    }
})
</script>
{% endblock %}

{% block content %}

<div class="container">
    <h1>{{ event.season.name }} {{ event.name }}</h1>
        &#8226; {{ event.when | timezone:event.timezone }} ({{ event.when | utc }} UTC)
        &#8226; <a href="{{ event.tournament_url }}" target="_blank">{{ event.tournament_url }}</a>
        &#8226; <br/>
    <hr />
    <div class="row">
        <div class="col-md-3">
            <h2>Teams</h2>
            <br />
            <ol>
            {% for team in event.teams.all|dictsort:"created" %}
                <li> {{ team.name }} <br />
                    <ol>
                    {% for player in team.members.all|dictsort:"user.id" %}
                        {% if player %}
                            <li> {{ player.user.get_full_name }} </li>
                        {% else %}
                            <strong><li> </li></strong>
                        {% endif %}
                    {% endfor %}
                </ol></li>
            {% endfor %}
            </ol>
        </div>

        <div class="col-md-5">
            <div id="vueApp">
                <div v-if="connected">
                    <h2>Tournament mode âš¡</h2>
                    <h3>On cab</h3>
                        <span style="color: rgb(170, 131, 25)">${ currentMatch.onGold }</span>
                        vs
                        <span style="color: rgb(69, 122, 236)">${ currentMatch.onBlue }</span>
                    <br />
                    <br />
                    <h3>Up next</h3>
                        <span style="color: rgb(170, 131, 25); font-size: larger; font-weight: bold">${ currentMatch.upGold }</span>
                        vs
                        <span style="color: rgb(69, 122, 236); font-size: larger; font-weight: bold">${ currentMatch.upBlue }</span>
                    <br />
                    <br />
                    <h3>Bracket</h3>
                    <ol>
                        <li v-for="set in sets">
                            <span style="color: rgb(170, 131, 25)">${ set.teams[0].name }
                                <span style="font-weight: bold" v-if="set.start_time">${ set.teams[0].score }</span>
                            </span>
                            vs
                            <span style="color: rgb(69, 122, 236)">${ set.teams[1].name }
                                <span style="font-weight: bold" v-if="set.start_time">${ set.teams[1].score }</span>
                            </span>
                        </li>
                    </ol>

                </div>
                <div v-if="!connected">
                    <h2>Tournament mode ðŸ›‘</h2>
                    Could not connect.  Please make sure you are on the same network or enter a new cab address:
                    <input type="text" v-model="cabAddress" />
                    <button
                        type="button"
                        class="btn btn-primary btn-md"
                        v-on:click="reconnect">Reconnect</button>
                        </div>
            </div>
        </div>
        <div class="col-md-4">
            <h2>Twitch chat</h2>
            <br />
            <iframe src="https://www.nightdev.com/hosted/obschat/?theme=light&channel=thecoinop&bot_activity=false&prevent_clipping=false"
             height="100%"
             width="100%"
             style="color:#000"></iframe>
        </div>
    </div>
</div>

{% endblock %}
